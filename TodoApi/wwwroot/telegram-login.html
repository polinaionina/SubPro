<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Telegram Auth</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .status { margin: 20px 0; padding: 15px; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        code { background: #f8f9fa; padding: 10px; display: block; overflow-x: auto; font-family: 'Courier New', monospace; border-radius: 3px; }
        button { padding: 12px 24px; margin: 10px 5px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; transition: background 0.3s; }
        button:hover { background: #0056b3; }
        button.secondary { background: #6c757d; }
        button.secondary:hover { background: #545b62; }
        .token-box { background: #e9ecef; padding: 15px; border-radius: 5px; margin: 15px 0; border: 1px solid #ced4da; }
        .debug-info { background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 15px 0; border-left: 4px solid #007bff; }
        h2 { color: #333; margin-bottom: 20px; }
        h3 { color: #555; margin-top: 0; }
    </style>
</head>
<body>
    <div class="container">
        <h2>üîê –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Telegram</h2>
        
        <div class="debug-info">
            <h3>–û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</h3>
            <div id="debug-info"></div>
        </div>

        <div style="text-align: center; margin: 20px 0;">
            <div id="tg-login"></div>
        </div>

        <div id="status"></div>
        
        <div style="margin-top: 30px; border-top: 2px solid #e9ecef; padding-top: 20px;">
            <h3>üß™ –¢–µ—Å—Ç–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏</h3>
            <p style="color: #666; margin-bottom: 15px;">–ï—Å–ª–∏ Telegram Widget –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç—Ç–∏ –∫–Ω–æ–ø–∫–∏:</p>
            
            <button onclick="getSimpleToken()">üéØ –ü–æ–ª—É—á–∏—Ç—å –ø—Ä–æ—Å—Ç–æ–π JWT —Ç–æ–∫–µ–Ω</button>
            <button onclick="testWithCurrentToken()" class="secondary">üß™ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å —Ç–æ–∫–µ–Ω–æ–º</button>
            <button onclick="clearAll()" class="secondary">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>
        </div>

        <div id="token-display" style="display: none; margin-top: 20px;"></div>
    </div>

    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
        const API_URL = "https://droopingly-troughlike-dedra.ngrok-free.dev";
        const urlParams = new URLSearchParams(window.location.search);
        const nonce = urlParams.get('nonce');

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', function() {
            initDebugInfo();
            initTelegramWidget();
            loadStoredToken();
        });

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ URL –ø–æ—Å–ª–µ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞
        function checkUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            const telegramId = urlParams.get('telegramId');
            const deviceId = urlParams.get('deviceId');
            const success = urlParams.get('success');
            const error = urlParams.get('error');

            console.log('URL Params:', { token, telegramId, deviceId, success, error });

            if (token && telegramId) {
                displayToken(token, telegramId, deviceId);
                showStatus('‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Telegram —É—Å–ø–µ—à–Ω–∞!', 'success');
                
                // –û—á–∏—Å—Ç–∏—Ç—å URL –æ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
                window.history.replaceState({}, document.title, window.location.pathname);
            }

            if (error) {
                showStatus('‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ' + error, 'error');
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }

        // –û–±–Ω–æ–≤–∏—Ç–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é
        document.addEventListener('DOMContentLoaded', function() {
            checkUrlParams(); // –î–æ–±–∞–≤—å—Ç–µ —ç—Ç—É —Å—Ç—Ä–æ–∫—É –ü–ï–†–í–û–ô
            initDebugInfo();
            initTelegramWidget();
            loadStoredToken();
        });

        // –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
        function initDebugInfo() {
            const debugInfo = document.getElementById('debug-info');
            debugInfo.innerHTML = `
                <p><strong>Nonce:</strong> <code>${nonce || 'NOT FOUND'}</code></p>
                <p><strong>API URL:</strong> <code>${API_URL}</code></p>
                <p><strong>Bot:</strong> subapro_bot</p>
                <p><strong>–í—Ä–µ–º—è:</strong> ${new Date().toLocaleString('ru-RU')}</p>
                <p><strong>–°—Ç–∞—Ç—É—Å:</strong> <span id="connection-status">–ü—Ä–æ–≤–µ—Ä–∫–∞...</span></p>
            `;

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
            checkConnection();
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º
        function checkConnection() {
            fetch(API_URL + '/api/notifications/test')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('connection-status').innerHTML = 
                        '<span style="color: green;">‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ</span>';
                })
                .catch(error => {
                    document.getElementById('connection-status').innerHTML = 
                        '<span style="color: red;">‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ' + error.message + '</span>';
                });
        }

        // Telegram Widget
        function initTelegramWidget() {
            const script = document.createElement('script');
            script.src = "https://telegram.org/js/telegram-widget.js?22";
            script.async = true;
            script.setAttribute('data-telegram-login', 'subapro_bot');
            script.setAttribute('data-size', 'large');
            script.setAttribute('data-userpic', 'true');
            script.setAttribute('data-request-access', 'write');
            script.setAttribute('data-lang', 'ru');
            
            // –î–æ–±–∞–≤–ª—è–µ–º nonce –≤ URL –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
            let authUrl = API_URL + '/api/auth/telegram-callback';
            if (nonce) {
                authUrl += '?nonce=' + nonce;
            }
            
            script.setAttribute('data-auth-url', authUrl);
            
            script.onload = function() {
                console.log('Telegram Widget loaded with auth URL:', authUrl);
            };
            
            document.getElementById('tg-login').appendChild(script);
            
            console.log('Telegram Widget initialized with URL:', authUrl);
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–æ—Å—Ç–æ–≥–æ —Ç–æ–∫–µ–Ω–∞ (–±–µ–∑ nonce)
        function getSimpleToken() {
            showStatus('üîÑ –ü–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–æ—Å—Ç–æ–≥–æ —Ç–æ–∫–µ–Ω–∞...', 'info');
            
            fetch(API_URL + '/api/auth/simple-token', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('‚úÖ Simple token response:', data);
                if (data.token) {
                    displayToken(data.token, data.telegramId, data.deviceId);
                    showStatus('‚úÖ –ü—Ä–æ—Å—Ç–æ–π —Ç–æ–∫–µ–Ω —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω!', 'success');
                } else {
                    showStatus('‚ùå –û—à–∏–±–∫–∞: —Ç–æ–∫–µ–Ω –Ω–µ –ø–æ–ª—É—á–µ–Ω', 'error');
                }
            })
            .catch(error => {
                console.error('‚ùå Error getting simple token:', error);
                showStatus('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞: ' + error.message, 'error');
            });
        }

        // –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å —Ç–µ–∫—É—â–∏–º —Ç–æ–∫–µ–Ω–æ–º
        function testWithCurrentToken() {
            const token = localStorage.getItem('jwt_token');
            if (!token) {
                showStatus('‚ùå –°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∏—Ç–µ —Ç–æ–∫–µ–Ω!', 'error');
                return;
            }
            
            showStatus('üîÑ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞...', 'info');
            
            fetch(API_URL + '/api/secure/profile', {
                headers: { 
                    'Authorization': 'Bearer ' + token,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                showStatus('‚úÖ –¢–µ—Å—Ç —É—Å–ø–µ—à–µ–Ω! –¢–æ–∫–µ–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç.', 'success');
                console.log('Profile response:', data);
            })
            .catch(error => {
                showStatus('‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∞: ' + error.message, 'error');
            });
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞
        function displayToken(token, telegramId, deviceId) {
            console.log('Displaying token:', { token, telegramId, deviceId });
            
            localStorage.setItem('jwt_token', token);
            localStorage.setItem('telegram_id', telegramId);
            if (deviceId) {
                localStorage.setItem('device_id', deviceId);
            }
            
            const tokenDisplay = document.getElementById('token-display');
            tokenDisplay.style.display = 'block';
            tokenDisplay.innerHTML = `
                <div class="status success">
                    <h3>üéâ JWT –¢–æ–∫–µ–Ω –ø–æ–ª—É—á–µ–Ω!</h3>
                    <p><strong>Telegram ID:</strong> ${telegramId}</p>
                    <p><strong>Device ID:</strong> ${deviceId || 'N/A'}</p>
                    
                    <div class="token-box">
                        <strong>–í–∞—à JWT Token (–ø–µ—Ä–≤—ã–µ 50 —Å–∏–º–≤–æ–ª–æ–≤):</strong>
                        <code style="word-break: break-all; font-size: 12px;">${token.substring(0, 50)}...</code>
                    </div>
                    
                    <p><strong>–ü–æ–ª–Ω—ã–π —Ç–æ–∫–µ–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ localStorage</strong></p>
                    
                    <div style="margin-top: 15px;">
                        <button onclick="copyToken()">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–∫–µ–Ω</button>
                        <button onclick="testWithCurrentToken()" class="secondary">üß™ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–∫–µ–Ω</button>
                        <button onclick="showFullToken()" class="secondary">üëÅÔ∏è –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª–Ω—ã–π —Ç–æ–∫–µ–Ω</button>
                    </div>
                </div>
            `;
        }

        function showFullToken() {
            const token = localStorage.getItem('jwt_token');
            if (token) {
                alert('–ü–æ–ª–Ω—ã–π —Ç–æ–∫–µ–Ω:\n\n' + token);
            }
        }

        // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
        function copyToken() {
            const token = localStorage.getItem('jwt_token');
            if (token) {
                navigator.clipboard.writeText(token).then(() => {
                    showStatus('‚úÖ –¢–æ–∫–µ–Ω —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!', 'success');
                }).catch(err => {
                    showStatus('‚ùå –û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è: ' + err, 'error');
                });
            }
        }

        // –¢–µ—Å—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        function testNotification() {
            const token = localStorage.getItem('jwt_token');
            if (!token) {
                showStatus('‚ùå –°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∏—Ç–µ —Ç–æ–∫–µ–Ω!', 'error');
                return;
            }
            
            showStatus('üîÑ –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è...', 'info');
            
            fetch(API_URL + '/api/notifications', {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + token,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    chatId: 123, // –±—É–¥–µ—Ç –ø—Ä–æ–∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è telegram_id –∏–∑ —Ç–æ–∫–µ–Ω–∞
                    message: '‚úÖ –¢–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å JWT —Ç–æ–∫–µ–Ω–æ–º! –í—Ä–µ–º—è: ' + new Date().toLocaleString('ru-RU')
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showStatus('‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!', 'success');
                } else {
                    showStatus('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + data.error, 'error');
                }
            })
            .catch(error => {
                showStatus('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message, 'error');
            });
        }

        function checkCurrentToken() {
            const token = localStorage.getItem('jwt_token');
            if (token) {
                showStatus('‚úÖ –¢–æ–∫–µ–Ω –Ω–∞–π–¥–µ–Ω –≤ localStorage', 'success');
                console.log('Current token:', token);
            } else {
                showStatus('‚ùå –¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ localStorage', 'error');
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ —Ç–æ–∫–µ–Ω–∞
        function loadStoredToken() {
            const token = localStorage.getItem('jwt_token');
            if (token) {
                const tokenDisplay = document.getElementById('token-display');
                tokenDisplay.style.display = 'block';
                tokenDisplay.innerHTML = `
                    <div class="status warning">
                        <h3>üìÅ –ù–∞–π–¥–µ–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —Ç–æ–∫–µ–Ω</h3>
                        <p>–¢–æ–∫–µ–Ω —É–∂–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ localStorage.</p>
                        <button onclick="getSimpleToken()">üîÑ –ü–æ–ª—É—á–∏—Ç—å –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω</button>
                        <button onclick="testWithCurrentToken()" class="secondary">üß™ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—É—â–∏–π</button>
                    </div>
                `;
            }
        }

        // –û—á–∏—Å—Ç–∫–∞ –≤—Å–µ–≥–æ
        function clearAll() {
            localStorage.removeItem('jwt_token');
            document.getElementById('token-display').style.display = 'none';
            document.getElementById('status').innerHTML = '';
            showStatus('‚úÖ –í—Å–µ –¥–∞–Ω–Ω—ã–µ –æ—á–∏—â–µ–Ω—ã', 'success');
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å
        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
            
            // –ê–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞ —É—Å–ø–µ—à–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
            if (type === 'success') {
                setTimeout(() => {
                    if (statusDiv.innerHTML.includes(message)) {
                        statusDiv.innerHTML = '';
                    }
                }, 5000);
            }
        }

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –æ—à–∏–±–æ–∫
        window.addEventListener('error', function(e) {
            console.error('Global error:', e.error);
            showStatus('‚ùå JavaScript –æ—à–∏–±–∫–∞: ' + e.message, 'error');
        });

        window.addEventListener('unhandledrejection', function(e) {
            console.error('Unhandled promise rejection:', e.reason);
            showStatus('‚ùå –û—à–∏–±–∫–∞ Promise: ' + e.reason, 'error');
        });
    </script>
</body>
</html>